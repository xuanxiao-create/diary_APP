<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ—¥ç¯è®° - è§’è‰²ç³»ç»Ÿè°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .user-item { padding: 10px; margin: 5px 0; border: 1px solid #eee; border-radius: 3px; }
        .role-admin { background-color: #fee; }
        .role-user { background-color: #efe; }
        .role-guest { background-color: #eef; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ—¥ç¯è®°APP - è§’è‰²ç³»ç»Ÿè°ƒè¯•å·¥å…·</h1>
        
        <!-- ç”¨æˆ·æ•°æ®æ£€æŸ¥ -->
        <div class="section">
            <h2>ğŸ“Š ç”¨æˆ·æ•°æ®æ£€æŸ¥</h2>
            <button onclick="checkUserData()">æ£€æŸ¥æ‰€æœ‰ç”¨æˆ·æ•°æ®</button>
            <div id="user-data-output"></div>
        </div>

        <!-- ç™»å½•æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ” ç™»å½•æµ‹è¯•</h2>
            <div>
                <input type="text" id="test-username" placeholder="ç”¨æˆ·å" value="admin">
                <input type="password" id="test-password" placeholder="å¯†ç " value="admin123">
                <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
                <button onclick="testWrongPassword()">æµ‹è¯•é”™è¯¯å¯†ç  (admin/123456)</button>
            </div>
            <div id="login-result"></div>
        </div>

        <!-- è§’è‰²æ˜¾ç¤ºæµ‹è¯• -->
        <div class="section">
            <h2>ğŸ‘¤ è§’è‰²æ˜¾ç¤ºæµ‹è¯•</h2>
            <div id="current-user-display">
                <p>å½“å‰ç”¨æˆ·: <span id="current-username">æœªç™»å½•</span></p>
                <p>å½“å‰è§’è‰²: <span id="current-role">æœªç™»å½•</span></p>
                <p>è§’è‰²å¾½ç« : <span id="role-badge-test" class="role-badge hidden">æ— </span></p>
            </div>
            <button onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•admin/admin123</button>
            <button onclick="simulateWrongLogin()">æ¨¡æ‹Ÿç™»å½•admin/123456</button>
            <button onclick="clearCurrentUser()">æ¸…é™¤å½“å‰ç”¨æˆ·</button>
        </div>

        <!-- ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯• -->
        <div class="section">
            <h2>ğŸ› ï¸ ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•</h2>
            <button onclick="checkAdminFunctions()">æ£€æŸ¥ç®¡ç†å‘˜åŠŸèƒ½</button>
            <div id="admin-test-result"></div>
        </div>

        <!-- ä¿®å¤å·¥å…· -->
        <div class="section">
            <h2>ğŸ”§ ä¿®å¤å·¥å…·</h2>
            <button onclick="fixAdminAccount()">ä¿®å¤ç®¡ç†å‘˜è´¦å· (admin/admin123)</button>
            <button onclick="createMissingAdmin()">åˆ›å»ºç¼ºå¤±çš„ç®¡ç†å‘˜è´¦å·</button>
            <button onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            <div id="fix-result"></div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥ç”¨æˆ·æ•°æ®
        function checkUserData() {
            const output = document.getElementById('user-data-output');
            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            
            output.innerHTML = '<h3>æ³¨å†Œç”¨æˆ·åˆ—è¡¨ï¼š</h3>';
            if (users.length === 0) {
                output.innerHTML += '<p class="error">âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç”¨æˆ·æ•°æ®</p>';
            } else {
                users.forEach(user => {
                    const roleClass = `role-${user.role}`;
                    output.innerHTML += `
                        <div class="user-item ${roleClass}">
                            <strong>ç”¨æˆ·å:</strong> ${user.username}<br>
                            <strong>å¯†ç :</strong> ${user.password}<br>
                            <strong>è§’è‰²:</strong> ${user.role}<br>
                            <strong>é‚®ç®±:</strong> ${user.email || 'æœªè®¾ç½®'}<br>
                            <strong>åˆ›å»ºæ—¶é—´:</strong> ${user.created_at || 'æœªçŸ¥'}
                        </div>
                    `;
                });
            }
            
            output.innerHTML += '<h3>å½“å‰ç™»å½•ç”¨æˆ·ï¼š</h3>';
            if (currentUser) {
                output.innerHTML += `
                    <div class="user-item">
                        <strong>ç”¨æˆ·å:</strong> ${currentUser.username}<br>
                        <strong>è§’è‰²:</strong> ${currentUser.role}<br>
                        <strong>ç™»å½•æ—¶é—´:</strong> ${currentUser.login_time || 'æœªçŸ¥'}
                    </div>
                `;
            } else {
                output.innerHTML += '<p class="warning">âš ï¸ å½“å‰æ²¡æœ‰ç”¨æˆ·ç™»å½•</p>';
            }
        }

        // æµ‹è¯•ç™»å½•åŠŸèƒ½
        function testLogin() {
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;
            const result = document.getElementById('login-result');
            
            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                // æ¨¡æ‹Ÿç™»å½•
                localStorage.setItem('currentUser', JSON.stringify({
                    ...user,
                    login_time: new Date().toISOString()
                }));
                
                result.innerHTML = `
                    <p class="success">âœ… ç™»å½•æˆåŠŸ!</p>
                    <p>ç”¨æˆ·å: ${user.username}</p>
                    <p>è§’è‰²: ${user.role}</p>
                `;
                
                updateCurrentUserDisplay();
            } else {
                result.innerHTML = `
                    <p class="error">âŒ ç™»å½•å¤±è´¥!</p>
                    <p>ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯</p>
                    <p>å°è¯•çš„ç”¨æˆ·å: ${username}</p>
                    <p>å°è¯•çš„å¯†ç : ${password}</p>
                `;
            }
        }

        // æµ‹è¯•é”™è¯¯å¯†ç 
        function testWrongPassword() {
            document.getElementById('test-username').value = 'admin';
            document.getElementById('test-password').value = '123456';
            testLogin();
        }

        // æ›´æ–°å½“å‰ç”¨æˆ·æ˜¾ç¤º
        function updateCurrentUserDisplay() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const usernameSpan = document.getElementById('current-username');
            const roleSpan = document.getElementById('current-role');
            const roleBadge = document.getElementById('role-badge-test');
            
            if (currentUser) {
                usernameSpan.textContent = currentUser.username;
                roleSpan.textContent = currentUser.role;
                roleBadge.textContent = getRoleDisplayName(currentUser.role);
                roleBadge.className = `role-badge role-${currentUser.role}`;
                roleBadge.classList.remove('hidden');
            } else {
                usernameSpan.textContent = 'æœªç™»å½•';
                roleSpan.textContent = 'æœªç™»å½•';
                roleBadge.className = 'role-badge hidden';
                roleBadge.textContent = 'æ— ';
            }
        }

        // è·å–è§’è‰²æ˜¾ç¤ºåç§°
        function getRoleDisplayName(role) {
            switch(role) {
                case 'admin': return 'ç®¡ç†å‘˜';
                case 'guest': return 'æ¸¸å®¢';
                case 'user': return 'ç”¨æˆ·';
                default: return 'æœªçŸ¥';
            }
        }

        // æ¨¡æ‹Ÿç™»å½•admin/admin123
        function simulateLogin() {
            document.getElementById('test-username').value = 'admin';
            document.getElementById('test-password').value = 'admin123';
            testLogin();
        }

        // æ¨¡æ‹Ÿç™»å½•admin/123456
        function simulateWrongLogin() {
            document.getElementById('test-username').value = 'admin';
            document.getElementById('test-password').value = '123456';
            testLogin();
        }

        // æ¸…é™¤å½“å‰ç”¨æˆ·
        function clearCurrentUser() {
            localStorage.removeItem('currentUser');
            updateCurrentUserDisplay();
            document.getElementById('login-result').innerHTML = '<p class="success">âœ… å·²æ¸…é™¤å½“å‰ç”¨æˆ·</p>';
        }

        // æ£€æŸ¥ç®¡ç†å‘˜åŠŸèƒ½
        function checkAdminFunctions() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            const result = document.getElementById('admin-test-result');
            
            if (!currentUser) {
                result.innerHTML = '<p class="error">âŒ è¯·å…ˆç™»å½•</p>';
                return;
            }
            
            const isAdmin = currentUser.role === 'admin';
            result.innerHTML = `
                <p><strong>å½“å‰ç”¨æˆ·:</strong> ${currentUser.username}</p>
                <p><strong>ç”¨æˆ·è§’è‰²:</strong> ${currentUser.role}</p>
                <p><strong>æ˜¯å¦ä¸ºç®¡ç†å‘˜:</strong> ${isAdmin ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
                <p><strong>ç®¡ç†å‘˜åŠŸèƒ½:</strong></p>
                <ul>
                    <li>${isAdmin ? 'âœ…' : 'âŒ'} è®¿é—®ç®¡ç†å‘˜é¢æ¿</li>
                    <li>${isAdmin ? 'âœ…' : 'âŒ'} ä¿®æ”¹ç”¨æˆ·è§’è‰²</li>
                    <li>${isAdmin ? 'âœ…' : 'âŒ'} æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·æ•°æ®</li>
                    <li>${isAdmin ? 'âœ…' : 'âŒ'} ç³»ç»Ÿç®¡ç†åŠŸèƒ½</li>
                </ul>
            `;
        }

        // ä¿®å¤ç®¡ç†å‘˜è´¦å·
        function fixAdminAccount() {
            const result = document.getElementById('fix-result');
            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            
            // æŸ¥æ‰¾æˆ–åˆ›å»ºadminç”¨æˆ·
            let adminUser = users.find(u => u.username === 'admin');
            
            if (adminUser) {
                // æ›´æ–°å¯†ç ä¸ºadmin123
                adminUser.password = 'admin123';
                adminUser.role = 'admin';
                result.innerHTML = '<p class="success">âœ… å·²æ›´æ–°ç®¡ç†å‘˜è´¦å·å¯†ç ä¸º: admin123</p>';
            } else {
                // åˆ›å»ºæ–°çš„adminç”¨æˆ·
                adminUser = {
                    id: 'admin_' + Date.now(),
                    username: 'admin',
                    email: 'admin@example.com',
                    password: 'admin123',
                    role: 'admin',
                    created_at: new Date().toISOString()
                };
                users.push(adminUser);
                result.innerHTML = '<p class="success">âœ… å·²åˆ›å»ºç®¡ç†å‘˜è´¦å·: admin/admin123</p>';
            }
            
            localStorage.setItem('registeredUsers', JSON.stringify(users));
            checkUserData();
        }

        // åˆ›å»ºç¼ºå¤±çš„ç®¡ç†å‘˜è´¦å·
        function createMissingAdmin() {
            const result = document.getElementById('fix-result');
            const users = JSON.parse(localStorage.getItem('registeredUsers') || '[]');
            
            // ç¡®ä¿æœ‰demoç”¨æˆ·
            let demoUser = users.find(u => u.username === 'demo');
            if (!demoUser) {
                demoUser = {
                    id: 'demo_' + Date.now(),
                    username: 'demo',
                    email: 'demo@example.com',
                    password: '123456',
                    role: 'user',
                    created_at: new Date().toISOString()
                };
                users.push(demoUser);
            }
            
            // ç¡®ä¿æœ‰adminç”¨æˆ·
            let adminUser = users.find(u => u.username === 'admin');
            if (!adminUser) {
                adminUser = {
                    id: 'admin_' + Date.now(),
                    username: 'admin',
                    email: 'admin@example.com',
                    password: 'admin123',
                    role: 'admin',
                    created_at: new Date().toISOString()
                };
                users.push(adminUser);
                result.innerHTML = '<p class="success">âœ… å·²åˆ›å»ºå®Œæ•´çš„æµ‹è¯•è´¦å·</p>';
            } else {
                adminUser.password = 'admin123';
                adminUser.role = 'admin';
                result.innerHTML = '<p class="success">âœ… å·²ä¿®å¤ç®¡ç†å‘˜è´¦å·</p>';
            }
            
            localStorage.setItem('registeredUsers', JSON.stringify(users));
            checkUserData();
        }

        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç”¨æˆ·å’Œä»»åŠ¡æ•°æ®ï¼')) {
                localStorage.clear();
                updateCurrentUserDisplay();
                document.getElementById('user-data-output').innerHTML = '<p class="success">âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©º</p>';
                document.getElementById('login-result').innerHTML = '';
                document.getElementById('admin-test-result').innerHTML = '';
                document.getElementById('fix-result').innerHTML = '<p class="success">âœ… æ•°æ®å·²æ¸…ç©ºï¼Œåˆ·æ–°é¡µé¢åç³»ç»Ÿä¼šé‡æ–°åˆ›å»ºé»˜è®¤æ•°æ®</p>';
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            updateCurrentUserDisplay();
            checkUserData();
        };
    </script>
</body>
</html>